<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문제 JSON 편집기 ver. 251231</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIARBEGEOOfWtlpZaxw7cmxM1rYUqHDGKNbsliTNrBCrlWO" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmIm0HTML" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/mhchem.min.js" xintegrity="sha384-LgC43YvcQdIuZoapfNSIKchwS2cScEDcB2tNn9L+fxtwW6Qp7zH+Bf0MsmC/TvoL" crossorigin="anonymous"></script>

    <!-- math.js (evaluation for min/max & symbol check) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .katex-display { text-align: left !important; }

        /* --- LaTeX Toolbar styles (ported) --- */
        .toolbar-btn {
            font-family: 'Times New Roman', serif;
            min-width: 2.2rem;
            height: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            font-size: 0.9rem;
            padding: 0 0.4rem;
        }
        .toolbar-btn:active { transform: translateY(1px); background-color: #e5e7eb; }
        .toolbar-btn:hover { background-color: #f3f4f6; border-color: #9ca3af; }

        .tab-btn { transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active {
            color: #2563EB;
            border-bottom-color: #2563EB;
            background-color: #EFF6FF;
            font-weight: 600;
        }

        .toolbar-scroll::-webkit-scrollbar { height: 6px; }
        .toolbar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }


/* --- Toolbar layout tokens (consistent spacing across ALL tabs) --- */
:root{
    --tb-gap: 0.25rem;                     /* gap between buttons */
    --tb-label-mb: calc(var(--tb-gap) + 0.125rem); /* label -> buttons */
    --tb-divider-my: 0.25rem;              /* space around divider line */
    --tb-block-gap: 0.5rem;                /* gap between subsection blocks (grid) */
}

/* Make every toolbar tab render with the same vertical rhythm */
.toolbar-content{
    display: block;
}

/* 2-column layout for subsection blocks (groups) */
.tb-grid{
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--tb-block-gap);
}
@media (max-width: 640px){
    .tb-grid{ grid-template-columns: 1fr; }
}

.tb-section{
    width: 100%;
    min-width: 0;
}

.tb-label{
    width: 100%;
    font-size: 10px;
    color: #9ca3af; /* gray-400 */
    margin: 0 0 var(--tb-label-mb) 0;
    padding: 0;
    line-height: 1.2;
}

.tb-buttons{
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: var(--tb-gap);
}

.tb-divider{
    width: 100%;
    height: 1px;
    background: #e5e7eb; /* gray-200 */
    margin: var(--tb-divider-my) 0;
}
input, textarea {
            transition: all 0.2s ease-in-out;
        }
        input:focus, textarea:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            border-color: #3B82F6;
        }
        .preview-container h3 {
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
    /* --- Layout hardening for 2-column grid --- */
.preview-container { min-width: 0; overflow: hidden; }
.preview-container .prose { min-width: 0; overflow-x: auto; }
.katex-display { overflow-x: auto; overflow-y: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 md:p-8">
    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <h1 class="text-2xl font-bold text-gray-900">문제 JSON 편집기 ver. 251231</h1>
            <div class="flex flex-wrap items-center gap-2">
                <button id="load-json" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">JSON 불러오기</button>
                <button id="save-json" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">JSON 저장하기</button>
                <div class="border-l border-gray-300 h-8 mx-1"></div>
                <label for="question-select" class="text-sm text-gray-700">문항 선택:</label>
                <select id="question-select" class="border-gray-300 rounded-md text-sm p-1"></select>
                <button id="add-question" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-gray-700 transition-colors text-sm">문항 추가</button>
                <button id="delete-question" class="bg-red-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-red-600 transition-colors text-sm disabled:bg-gray-400 disabled:cursor-not-allowed">문항 삭제</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Inputs -->
            <section class="lg:col-span-1 min-w-0 space-y-6 bg-white p-6 rounded-lg shadow">
                <div>
                    <label for="id" class="block text-sm font-medium text-gray-700">ID</label>
                    <input type="text" id="id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="예: PHY2_01">
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">제목</label>
                    <input type="text" id="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="예: 두 점전하 사이의 정전기력">
                </div>

                <div>
                    <label for="points" class="block text-sm font-medium text-gray-700">
                        배점 <span class="text-xs text-gray-400">(선택)</span>
                    </label>
                    <input type="number" id="points" step="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="예: 5">
                </div>

                <!-- ===== LaTeX Toolbar (ported) ===== -->
                <div class="border border-gray-200 rounded-md bg-gray-50 flex-none flex flex-col">
                    <div class="flex justify-between items-center border-b border-gray-200 bg-white px-1 overflow-x-auto">
                        <div class="flex text-xs font-semibold text-gray-500">
                            <button type="button" class="tab-btn active px-3 py-2 border-b-2 border-transparent hover:text-blue-600" data-tab="basic">기본</button>
                            <button type="button" class="tab-btn px-3 py-2 border-b-2 border-transparent hover:text-blue-600" data-tab="greek">그리스</button>
                            <button type="button" class="tab-btn px-3 py-2 border-b-2 border-transparent hover:text-blue-600" data-tab="fonts">글꼴/기호</button>
                            <button type="button" class="tab-btn px-3 py-2 border-b-2 border-transparent hover:text-blue-600" data-tab="operators">연산</button>
                            <button type="button" class="tab-btn px-3 py-2 border-b-2 border-transparent hover:text-blue-600" data-tab="functions">함수</button>
                        </div>
                        <div id="focus-indicator" class="flex-none mr-2 text-[11px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded border border-blue-100 shadow-sm whitespace-nowrap">
                            입력 대상: 지문
                        </div>
                    </div>

                    <div class="p-2 max-h-50 overflow-y-auto toolbar-scroll">
                        <div id="toolbar-basic" class="toolbar-content flex flex-wrap gap-1">
                            <button type="button" class="toolbar-btn bg-white border rounded text-blue-600 font-bold" data-code="*" data-suffix="*" title="변수 입력">var</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="$" data-suffix="$" data-move="-1">$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="$$" data-suffix="$$" data-move="-2">$$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="\frac{}{}" data-move="-3">$\frac{a}{b}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="^{}" data-move="-1">$x^n$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="_{}" data-move="-1">$x_n$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="^{\circ}" data-move="0">°</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="^{\prime}">′</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="^{\prime\prime}">″</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="\sqrt{}" data-move="-1">$\sqrt{x}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="\left( \right)" data-move="-7">$( )$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="\left\{ \right\}" data-move="-8">$\{ \}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded" data-code="\left[ \right]" data-move="-7">$[ ]$</button>
                        </div>

                        <div id="toolbar-greek" class="toolbar-content hidden flex flex-wrap gap-1"></div>

                        <div id="toolbar-fonts" class="toolbar-content hidden flex flex-wrap gap-1">
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\mathrm{}" data-move="-1">$\mathrm{A}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\mathbb{}" data-move="-1">$\mathbb{A}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\mathcal{}" data-move="-1">$\mathcal{A}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\mathbf{}" data-move="-1">$\mathbf{A}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\vec{}" data-move="-1">$\vec{a}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\hat{}" data-move="-1">$\hat{a}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\dot{}" data-move="-1">$\dot{a}$</button>
                            <button type="button" class="toolbar-btn bg-white border rounded px-2 text-xs" data-code="\ddot{}" data-move="-1">$\ddot{a}$</button>
                        </div>

                        <div id="toolbar-operators" class="toolbar-content hidden">
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">사칙연산/관계</span>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\times ">$\times$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\cdot ">$\cdot$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\pm ">$\pm$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\approx ">$\approx$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\neq ">$\neq$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\le ">$\le$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\ge ">$\ge$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\infty ">$\infty$</button>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">미적분/기타</span>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\int ">$\int$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\oint ">$\oint$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\sum ">$\sum$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\prod ">$\prod$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\partial ">$\partial$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\nabla ">$\nabla$</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">화살표</span>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\leftarrow ">←</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\rightarrow ">→</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\leftrightarrow ">↔</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\Leftarrow ">⇐</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\Rightarrow ">⇒</button>
                                <button type="button" class="toolbar-btn bg-white border rounded" data-code="\Leftrightarrow ">⇔</button>
                            </div>
                        </div>

                        <div id="toolbar-functions" class="toolbar-content hidden">
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">삼각함수</span>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\sin ">$\sin$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\cos ">$\cos$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\tan ">$\tan$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\csc ">$\csc$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\sec ">$\sec$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\cot ">$\cot$</button>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-2">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">역삼각함수</span>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs px-2" data-code="\arcsin ">$\arcsin$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs px-2" data-code="\arccos ">$\arccos$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs px-2" data-code="\arctan ">$\arctan$</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span class="text-[10px] text-gray-400 w-full mb-0.5">로그/지수</span>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\log ">$\log$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\ln ">$\ln$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="e^{}" data-move="-1">$e^x$</button>
                                <button type="button" class="toolbar-btn bg-white border rounded text-xs" data-code="\exp ">$\exp$</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ===== /LaTeX Toolbar ===== -->

                <div>
                    <label for="text" class="block text-sm font-medium text-gray-700">지문 (변수는 *var* 형식)</label>
                    <textarea id="text" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 font-mono" placeholder="예: 전하량 $q_{1} = *a*$ C ..."></textarea>
                </div>
                <div>
                    <label for="answer" class="block text-sm font-medium text-gray-700">정답식</label>
                    <textarea id="answer" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 font-mono" placeholder="예: \frac{kq_{1}q_{2}}{r^{2}}"></textarea>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-800 mb-2">변수 정보</h3>
                    <div id="variables-container" class="space-y-2">
                        <p class="text-sm text-gray-500">지문에 변수를 입력하면 자동으로 생성됩니다.</p>
                    </div>
                </div>
            </section>

            <!-- Right Column: Preview + Errors -->
            <section class="lg:col-span-1 min-w-0 space-y-6">
                <div class="bg-white p-6 rounded-lg shadow preview-container">
                    <h3 class="text-xl">지문 미리보기 (KaTeX 렌더링)</h3>
                    <div id="text-preview" class="prose max-w-none overflow-x-auto"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow preview-container">
                    <h3 class="text-xl">정답식 미리보기 (KaTeX 렌더링)</h3>
                    <div id="answer-preview" class="prose max-w-none overflow-x-auto"></div>
                </div>

<div class="bg-white p-6 rounded-lg shadow preview-container">
    <div class="flex items-start justify-between gap-3">
        <div>
            <h3 class="text-xl">정답 범위 (min/max)</h3>
            <p class="mt-1 text-xs text-gray-500">
                정답식(LaTeX)을 변환한 뒤, 주어진 변수 범위에서 근사적으로 최소/최대값을 탐색합니다.
            </p>
        </div>
    </div>

    <div class="mt-4 flex flex-wrap items-center gap-2">
        <button id="calc-minmax" type="button"
            class="bg-indigo-600 text-white font-semibold py-2 px-3 rounded-md hover:bg-indigo-700 transition-colors text-sm">
            현재 문제 점검
        </button>

        <button id="calc-minmax-all" type="button"
            class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-3 rounded-md hover:bg-indigo-200 transition-colors text-sm border border-indigo-200">
            전체 문제 점검
        </button>

        <div class="ml-0 sm:ml-2 flex items-center gap-2 text-sm text-gray-600">
            <span class="font-medium">샘플</span>
            <input id="minmax-samples" type="number" min="200" step="100" value="2000"
                class="w-28 p-1 rounded-md border border-gray-300 text-right bg-white">
        </div>

        <div class="flex items-center gap-2 text-sm text-gray-600">
            <span class="font-medium">시드</span>
            <input id="minmax-seed" type="number" step="1" value="1"
                class="w-24 p-1 rounded-md border border-gray-300 text-right bg-white">
        </div>
    </div>

    <div id="answer-mathjs"
        class="mt-3 text-xs text-gray-700 font-mono break-all bg-gray-50 border border-gray-200 rounded-md p-2 hidden"></div>

    <div id="minmax-result" class="mt-3 hidden"></div>

    <div id="minmax-all-result" class="mt-3 hidden"></div>
    <div id="minmax-report-table" class="mt-3 hidden"></div>

</div>
                <!-- 에러 표시 -->
                <div id="validation-errors" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>
            </section>
        </main>
        
        <input type="file" id="file-input" class="hidden" accept=".json">
    </div>

    <script>
        // =============================
        // LaTeX Toolbar Logic (ported)
        // =============================
        const toolbarState = { lastFocusedInputId: 'text' };

        function setActiveTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.toolbar-content').forEach(el => el.classList.add('hidden'));
            const pane = document.getElementById('toolbar-' + tabName);
            if (pane) pane.classList.remove('hidden');
        }

        // ===== Data-driven LaTeX toolbar (no behavior changes) =====
        // Button actions:
        // - wrap: inserts prefix + (selection) + suffix, cursor positioning depends on selection state
        // - cmd: inserts \command + tail, selection (if any) remains after inserted text (same as legacy)
        // - tpl: inserts raw template, selection (if any) remains after inserted text (same as legacy)
        //
        // Cursor positioning:
        // - For cmd/tpl, cursor uses a marker '|' in the template and is converted to legacy move-offset
        //   so selection-length behavior stays identical to the original insertAtCursor(move) logic.

        const TOOLBAR_BTN_BASE_CLASS = 'toolbar-btn bg-white border rounded hover:bg-gray-100';

        function mkInlineLabel(text) {
            const div = document.createElement('div');
            div.className = 'tb-label';
            div.textContent = text;
            return div;
        }

function mkInlineDivider() {
            const d = document.createElement('div');
            d.className = 'tb-divider';
            return d;
        }

// Convert marker-template to (textWithoutMarker, moveFromEnd) to preserve legacy behavior.
        function splitMarkerToLegacyMove(strWithMarker) {
            const idx = strWithMarker.indexOf('|');
            if (idx === -1) return { text: strWithMarker, move: 0 };
            const text = strWithMarker.slice(0, idx) + strWithMarker.slice(idx + 1);
            const move = idx - text.length; // legacy move (usually negative)
            return { text, move };
        }

        function makeToolbarButton(cfg) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = TOOLBAR_BTN_BASE_CLASS + (cfg.cls ? (' ' + cfg.cls) : '');
            if (cfg.title) btn.title = cfg.title;

            if (cfg.kind === 'wrap') {
                btn.dataset.action = 'wrap';
                btn.dataset.prefix = cfg.prefix ?? '';
                btn.dataset.suffix = cfg.suffix ?? '';
                btn.dataset.cursorEmpty = cfg.cursorEmpty ?? 'inside';
                btn.dataset.cursorSelected = cfg.cursorSelected ?? btn.dataset.cursorEmpty;
            } else if (cfg.kind === 'cmd') {
                btn.dataset.action = 'cmd';
                btn.dataset.cmd = cfg.cmd ?? '';
                // default tail: single trailing space (matches legacy buttons like \sin␠, \alpha␠, etc.)
                btn.dataset.tail = (cfg.tail !== undefined) ? String(cfg.tail) : ' ';
            } else if (cfg.kind === 'tpl') {
                btn.dataset.action = 'tpl';
                btn.dataset.tpl = cfg.tpl ?? '';
            }

            if (cfg.labelHtml !== undefined && cfg.labelHtml !== null) btn.innerHTML = cfg.labelHtml;
            else btn.textContent = cfg.label ?? '';

            return btn;
        }

        const TOOLBAR_DEF = {
            
basic: {
    layout: 'groups',
    groups: [
        {
            title: '수식환경',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'wrap', label: 'var', cls: 'text-blue-600 font-bold', title: '변수 입력', prefix: '*', suffix: '*', cursorEmpty: 'inside', cursorSelected: 'after' },
                { kind: 'wrap', label: '$', prefix: '$', suffix: '$', cursorEmpty: 'inside', cursorSelected: 'inside' },
                { kind: 'wrap', label: '$$', prefix: '$$', suffix: '$$', cursorEmpty: 'inside', cursorSelected: 'inside' },
            ],
        },
        {
            title: '분수/첨자/제곱근',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'frac', tail: '{|}{}', labelHtml: '$\\frac{a}{b}$' },
                { kind: 'tpl', tpl: '^{|}', labelHtml: '$x^n$' },
                { kind: 'tpl', tpl: '_{|}', labelHtml: '$x_n$' },
                { kind: 'cmd', cmd: 'sqrt', tail: '{|}', labelHtml: '$\\sqrt{x}$' },
            ],
        },
        {
            title: '괄호',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'tpl', tpl: '\\left( |\\right)', labelHtml: '$( )$' },
                { kind: 'tpl', tpl: '\\left\\{ |\\right\\}', labelHtml: '$\\{ \\}$' },
                { kind: 'tpl', tpl: '\\left[ |\\right]', labelHtml: '$[ ]$' },
            ],
        },
        {
            title: '상수/단위',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'pi', labelHtml: 'π' },
                { kind: 'tpl', tpl: '^{\\circ}', label: '°' },
                { kind: 'tpl', tpl: '^{\\prime}', label: '′' },
                { kind: 'tpl', tpl: '^{\\prime\\prime}', label: '″' },
                { kind: 'tpl', tpl: '\\%', label: '%' },
            ],
        },
    ],
},greek: {
    layout: 'groups',
    groups: [
        {
            title: '소문자',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'alpha', label: 'α' },
                { kind: 'cmd', cmd: 'beta', label: 'β' },
                { kind: 'cmd', cmd: 'gamma', label: 'γ' },
                { kind: 'cmd', cmd: 'delta', label: 'δ' },
                { kind: 'cmd', cmd: 'epsilon', label: 'ε' },
                { kind: 'cmd', cmd: 'zeta', label: 'ζ' },
                { kind: 'cmd', cmd: 'eta', label: 'η' },
                { kind: 'cmd', cmd: 'theta', label: 'θ' },
                { kind: 'cmd', cmd: 'iota', label: 'ι' },
                { kind: 'cmd', cmd: 'kappa', label: 'κ' },
                { kind: 'cmd', cmd: 'lambda', label: 'λ' },
                { kind: 'cmd', cmd: 'mu', label: 'μ' },
                { kind: 'cmd', cmd: 'nu', label: 'ν' },
                { kind: 'cmd', cmd: 'xi', label: 'ξ' },
                { kind: 'cmd', cmd: 'pi', label: 'π' },
                { kind: 'cmd', cmd: 'rho', label: 'ρ' },
                { kind: 'cmd', cmd: 'sigma', label: 'σ' },
                { kind: 'cmd', cmd: 'tau', label: 'τ' },
                { kind: 'cmd', cmd: 'upsilon', label: 'υ' },
                { kind: 'cmd', cmd: 'phi', label: 'φ' },
                { kind: 'cmd', cmd: 'chi', label: 'χ' },
                { kind: 'cmd', cmd: 'psi', label: 'ψ' },
                { kind: 'cmd', cmd: 'omega', label: 'ω' },
            ],
        },
        {
            title: '대문자',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'Gamma', label: 'Γ' },
                { kind: 'cmd', cmd: 'Delta', label: 'Δ' },
                { kind: 'cmd', cmd: 'Theta', label: 'Θ' },
                { kind: 'cmd', cmd: 'Lambda', label: 'Λ' },
                { kind: 'cmd', cmd: 'Xi', label: 'Ξ' },
                { kind: 'cmd', cmd: 'Pi', label: 'Π' },
                { kind: 'cmd', cmd: 'Sigma', label: 'Σ' },
                { kind: 'cmd', cmd: 'Upsilon', label: 'Υ' },
                { kind: 'cmd', cmd: 'Phi', label: 'Φ' },
                { kind: 'cmd', cmd: 'Psi', label: 'Ψ' },
                { kind: 'cmd', cmd: 'Omega', label: 'Ω' },
            ],
        },
    ],
},
fonts: {
    layout: 'groups',
    groups: [
        {
            title: '서체',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'mathrm', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\mathrm{A}$' },
                { kind: 'cmd', cmd: 'mathbb', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\mathbb{A}$' },
                { kind: 'cmd', cmd: 'mathcal', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\mathcal{A}$' },
                { kind: 'cmd', cmd: 'mathbf', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\mathbf{A}$' },
            ],
        },
        {
            title: '장식',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'vec', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\vec{a}$' },
                { kind: 'cmd', cmd: 'hat', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\hat{a}$' },
                { kind: 'cmd', cmd: 'bar', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\bar{a}$' },
                { kind: 'cmd', cmd: 'dot', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\dot{a}$' },
                { kind: 'cmd', cmd: 'ddot', tail: '{|}', cls: 'px-2 text-xs', labelHtml: '$\\ddot{a}$' },
            ],
        },
        {
            title: '화살표',
            groupClass: 'flex flex-wrap gap-1 mb-2',
            buttons: [
                { kind: 'cmd', cmd: 'leftarrow', label: '←' },
                { kind: 'cmd', cmd: 'rightarrow', label: '→' },
                { kind: 'cmd', cmd: 'leftrightarrow', label: '↔' },
                { kind: 'cmd', cmd: 'Leftarrow', label: '⇐' },
                { kind: 'cmd', cmd: 'Rightarrow', label: '⇒' },
                { kind: 'cmd', cmd: 'Leftrightarrow', label: '⇔' },
            ],
        },
    ],
},operators: {
                layout: 'groups',
                groups: [
                    {
                        title: '사칙연산/관계',
                        groupClass: 'flex flex-wrap gap-1 mb-2',
                        buttons: [
                            { kind: 'cmd', cmd: 'times', labelHtml: '$\\times$' },
                            { kind: 'cmd', cmd: 'cdot', labelHtml: '$\\cdot$' },
                            { kind: 'cmd', cmd: 'pm', labelHtml: '$\\pm$' },
                            { kind: 'cmd', cmd: 'approx', labelHtml: '$\\approx$' },
                            { kind: 'cmd', cmd: 'neq', labelHtml: '$\\neq$' },
                            { kind: 'cmd', cmd: 'le', labelHtml: '$\\le$' },
                            { kind: 'cmd', cmd: 'ge', labelHtml: '$\\ge$' },
                            { kind: 'cmd', cmd: 'infty', labelHtml: '$\\infty$' },
                        ],
                    },
                    {
                        title: '미적분/기타',
                        groupClass: 'flex flex-wrap gap-1 mb-2',
                        buttons: [
                            { kind: 'cmd', cmd: 'int', labelHtml: '$\\int$' },
                            { kind: 'cmd', cmd: 'oint', labelHtml: '$\\oint$' },
                            { kind: 'cmd', cmd: 'sum', labelHtml: '$\\sum$' },
                            { kind: 'cmd', cmd: 'prod', labelHtml: '$\\prod$' },
                            { kind: 'cmd', cmd: 'partial', labelHtml: '$\\partial$' },
                            { kind: 'cmd', cmd: 'nabla', labelHtml: '$\\nabla$' },
                        ],
                    },
                    
                ],
            },

            functions: {
                layout: 'groups',
                groups: [
                    {
                        title: '삼각함수',
                        groupClass: 'flex flex-wrap gap-1 mb-2',
                        buttons: [
                            { kind: 'cmd', cmd: 'sin', cls: 'text-xs', labelHtml: '$\\sin$' },
                            { kind: 'cmd', cmd: 'cos', cls: 'text-xs', labelHtml: '$\\cos$' },
                            { kind: 'cmd', cmd: 'tan', cls: 'text-xs', labelHtml: '$\\tan$' },
                            { kind: 'cmd', cmd: 'csc', cls: 'text-xs', labelHtml: '$\\csc$' },
                            { kind: 'cmd', cmd: 'sec', cls: 'text-xs', labelHtml: '$\\sec$' },
                            { kind: 'cmd', cmd: 'cot', cls: 'text-xs', labelHtml: '$\\cot$' },
                        ],
                    },
                    {
                        title: '역삼각함수',
                        groupClass: 'flex flex-wrap gap-1 mb-2',
                        buttons: [
                            { kind: 'cmd', cmd: 'arcsin', cls: 'text-xs px-2', labelHtml: '$\\arcsin$' },
                            { kind: 'cmd', cmd: 'arccos', cls: 'text-xs px-2', labelHtml: '$\\arccos$' },
                            { kind: 'cmd', cmd: 'arctan', cls: 'text-xs px-2', labelHtml: '$\\arctan$' },
                        ],
                    },
                                        {
                        title: '쌍곡선함수',
                        groupClass: 'flex flex-wrap gap-1 mb-2',
                        buttons: [
                            { kind: 'cmd', cmd: 'sinh', cls: 'text-xs', labelHtml: '$\\sinh$' },
                            { kind: 'cmd', cmd: 'cosh', cls: 'text-xs', labelHtml: '$\\cosh$' },
                            { kind: 'cmd', cmd: 'tanh', cls: 'text-xs', labelHtml: '$\\tanh$' },
                        ],
                    },

                    {
                        title: '로그/지수',
                        groupClass: 'flex flex-wrap gap-1',
                        buttons: [
                            { kind: 'tpl', tpl: '\\log_{|}', cls: 'text-xs', labelHtml: '$\\log_{a}$' },
                            { kind: 'cmd', cmd: 'ln', cls: 'text-xs', labelHtml: '$\\ln$' },
{ kind: 'cmd', cmd: 'exp', cls: 'text-xs', labelHtml: '$\\exp$' },
                        ],
                    },
                ],
            },
        };

        function renderToolbarTab(tabName) {
    const def = TOOLBAR_DEF[tabName];
    const root = document.getElementById('toolbar-' + tabName);
    if (!def || !root) return;

    // Normalize root classes (keep hidden state, drop tab-specific flex/gap differences)
    const wasHidden = root.classList.contains('hidden');
    root.className = 'toolbar-content' + (wasHidden ? ' hidden' : '');

    root.innerHTML = '';
    const frag = document.createDocumentFragment();

    if (def.layout === 'inline') {
        // Stream items, but group buttons into flex-wrapping rows so divider/label spacing is uniform.
        let currentButtons = null;

        const ensureButtonsRow = () => {
            if (currentButtons) return;
            currentButtons = document.createElement('div');
            currentButtons.className = 'tb-buttons';
            frag.appendChild(currentButtons);
        };

        (def.items || []).forEach(item => {
            if (item.kind === 'label') {
                frag.appendChild(mkInlineLabel(item.text || ''));
                currentButtons = null;
            } else if (item.kind === 'divider') {
                frag.appendChild(mkInlineDivider());
                currentButtons = null;
            } else {
                ensureButtonsRow();
                currentButtons.appendChild(makeToolbarButton(item));
            }
        });

    } else if (def.layout === 'groups') {
    // Render subsection blocks in a 2-column grid for a more compact layout.
    const grid = document.createElement('div');
    grid.className = 'tb-grid';

    (def.groups || []).forEach((g) => {
        const section = document.createElement('div');
        section.className = 'tb-section';

        const label = document.createElement('div');
        label.className = 'tb-label';
        label.textContent = g.title || '';
        section.appendChild(label);

        const buttons = document.createElement('div');
        buttons.className = 'tb-buttons';
        (g.buttons || []).forEach(btnCfg => buttons.appendChild(makeToolbarButton(btnCfg)));
        section.appendChild(buttons);

        grid.appendChild(section);
    });

    frag.appendChild(grid);
    }

    root.appendChild(frag);
}

        function renderAllToolbars() {
            renderToolbarTab('basic');
            renderToolbarTab('greek');
            renderToolbarTab('fonts');
            renderToolbarTab('operators');
            renderToolbarTab('functions');
        }


        function insertAtCursor(input, prefix, suffix, moveCursor = 0) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const selected = text.substring(start, end);
            input.value = text.substring(0, start) + prefix + selected + suffix + text.substring(end);

            const newPos = start + prefix.length + selected.length + suffix.length + moveCursor;
            input.selectionStart = input.selectionEnd = newPos;
            input.focus();
            input.dispatchEvent(new Event('input', { bubbles: true }));
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAllToolbars();

            const createEmptyQuestion = () => ({
                id: '',
                title: '',
                text: '',
                answer: '',
                variables: [], // { name, min, max }
                points: '' // optional
            });

            const state = {
                questions: [createEmptyQuestion()],
                currentIndex: 0
            };

            const dom = {
                id: document.getElementById('id'),
                title: document.getElementById('title'),
                points: document.getElementById('points'),
                text: document.getElementById('text'),
                answer: document.getElementById('answer'),
                calcMinMaxBtn: document.getElementById('calc-minmax'),
                calcMinMaxAllBtn: document.getElementById('calc-minmax-all'),
                minmaxAllResult: document.getElementById('minmax-all-result'),
                minmaxReportTable: document.getElementById('minmax-report-table'),
                minmaxSamples: document.getElementById('minmax-samples'),
                minmaxSeed: document.getElementById('minmax-seed'),
                answerMathjs: document.getElementById('answer-mathjs'),
                minmaxResult: document.getElementById('minmax-result'),
                variablesContainer: document.getElementById('variables-container'),
                textPreview: document.getElementById('text-preview'),
                answerPreview: document.getElementById('answer-preview'),
                validationErrors: document.getElementById('validation-errors'),
                loadJsonBtn: document.getElementById('load-json'),
                saveJsonBtn: document.getElementById('save-json'),
                fileInput: document.getElementById('file-input'),
                questionSelect: document.getElementById('question-select'),
                addQuestionBtn: document.getElementById('add-question'),
                deleteQuestionBtn: document.getElementById('delete-question'),
                focusIndicator: document.getElementById('focus-indicator'),
            };

            // Tab click
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
            });

            // Focus Tracking
            const updateFocus = (e) => {
                toolbarState.lastFocusedInputId = e.target.id;
                if (dom.focusIndicator) {
                    dom.focusIndicator.textContent = `입력 대상: ${e.target.id === 'text' ? '지문' : '정답식'}`;
                }
            };
            dom.text.addEventListener('focus', updateFocus);
            dom.answer.addEventListener('focus', updateFocus);

            // Toolbar click (event delegation)
            document.querySelectorAll('.toolbar-content').forEach(container => {
                container.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    const targetInput = document.getElementById(toolbarState.lastFocusedInputId);
                    if (!targetInput) return;

                    const action = btn.dataset.action;

                    // --- New toolbar actions (data-driven) ---
                    if (action === 'wrap') {
                        const prefix = btn.dataset.prefix ?? '';
                        const suffix = btn.dataset.suffix ?? '';
                        const empty = targetInput.selectionStart === targetInput.selectionEnd;

                        const cursorMode = empty
                            ? (btn.dataset.cursorEmpty || 'inside')
                            : (btn.dataset.cursorSelected || 'inside');

                        const move = (cursorMode === 'inside') ? -suffix.length : 0;
                        insertAtCursor(targetInput, prefix, suffix, move);
                        return;
                    }

                    if (action === 'cmd') {
                        const cmd = btn.dataset.cmd ?? '';
                        const tail = (btn.dataset.tail !== undefined) ? btn.dataset.tail : ' ';
                        const { text, move } = splitMarkerToLegacyMove('\\' + cmd + tail);
                        insertAtCursor(targetInput, text, '', move);
                        return;
                    }

                    if (action === 'tpl') {
                        const tpl = btn.dataset.tpl ?? '';
                        const { text, move } = splitMarkerToLegacyMove(tpl);
                        insertAtCursor(targetInput, text, '', move);
                        return;
                    }

                    // --- Legacy fallback (data-code / data-suffix / data-move) ---
                    const code = btn.dataset.code ?? '';
                    const suffix = btn.dataset.suffix ?? '';
                    const move = parseInt(btn.dataset.move || '0', 10);

                    // UX tweak: $ / $$ / var buttons should place cursor inside when no selection
                    if ((code === '$' && suffix === '$') && targetInput.selectionStart === targetInput.selectionEnd) {
                        insertAtCursor(targetInput, '$', '$', -1);
                        return;
                    }
                    if ((code === '$$' && suffix === '$$') && targetInput.selectionStart === targetInput.selectionEnd) {
                        insertAtCursor(targetInput, '$$', '$$', -2);
                        return;
                    }
                    if ((code === '*' && suffix === '*') && targetInput.selectionStart === targetInput.selectionEnd) {
                        insertAtCursor(targetInput, '*', '*', -1);
                        return;
                    }

                    insertAtCursor(targetInput, code, suffix, move);
                });
            });

            const extractVariables = (...texts) => {
                const varRegex = /\*([a-zA-Z_][a-zA-Z0-9_]*)\*/g;
                let allVars = new Set();
                texts.forEach(text => {
                    if (!text) return;
                    let match;
                    while ((match = varRegex.exec(text)) !== null) {
                        allVars.add(match[1]);
                    }
                });
                return Array.from(allVars).sort();
            };
            
            const getDecimalPlaces = (numStr) => {
                if (!numStr) return 0;
                const s = String(numStr).trim();
                const parts = s.split('.');
                if (parts.length < 2) return 0;
                return parts[1].length;
            };


// =============================
// LaTeX -> math.js 변환 + 심볼 추출 + min/max
// =============================
const _LATEX_FUNC_MAP = {
    sin: 'sin', cos: 'cos', tan: 'tan',
    sinh: 'sinh', cosh: 'cosh', tanh: 'tanh',
    csc: 'csc', sec: 'sec', cot: 'cot',
    arcsin: 'asin', arccos: 'acos', arctan: 'atan',
    asin: 'asin', acos: 'acos', atan: 'atan',
    ln: 'log', log: 'log', exp: 'exp'
};

function _readGroup(s, i) {
    // s[i] must be '{'
    let depth = 0;
    const start = i + 1;
    for (let k = i; k < s.length; k++) {
        const ch = s[k];
        if (ch === '{') depth++;
        else if (ch === '}') depth--;
        if (depth === 0) return { content: s.slice(start, k), next: k + 1 };
    }
    throw new Error("LaTeX 중괄호 {}가 닫히지 않았습니다.");
}

function _readParenGroup(s, i) {
    // s[i] must be '('
    let depth = 0;
    for (let k = i; k < s.length; k++) {
        const c = s[k];
        if (c === '(') depth++;
        else if (c === ')') depth--;
        if (depth === 0) {
            return { content: s.slice(i + 1, k), next: k + 1 };
        }
    }
    throw new Error("LaTeX 괄호 ()가 닫히지 않았습니다.");
}

function _readAtom(s, i) {
    const ch = s[i];
    if (!ch) return { atom: '', next: i };
    if (ch === '{') {
        const g = _readGroup(s, i);
        return { atom: '(' + _latexToMathjsCore(g.content) + ')', next: g.next };
    }
    if (ch === '(') {
        const g = _readParenGroup(s, i);
        return { atom: '(' + _latexToMathjsCore(g.content) + ')', next: g.next };
    }
    const num = s.slice(i).match(/^[0-9]+(\.[0-9]+)?/);
    if (num) return { atom: num[0], next: i + num[0].length };
    const id = s.slice(i).match(/^[a-zA-Z_][a-zA-Z0-9_]*/);
    if (id) return { atom: id[0], next: i + id[0].length };
    return { atom: ch, next: i + 1 };
}

function _latexToMathjsCore(latex) {
    let s = String(latex || '');
    // remove $ delimiters and \left/\right
    s = s.replace(/\$/g, '');
    s = s.replace(/\\left/g, '').replace(/\\right/g, '');

    // spacing commands
    s = s.replace(/\\,/g, '').replace(/\\;/g, '').replace(/\\!/g, '').replace(/\\\s/g, '');

    // operators
    s = s.replace(/\\times\b/g, '*').replace(/\\cdot\b/g, '*');

    // constants/symbols
    s = s.replace(/\\pi\b/g, 'pi');
    s = s.replace(/\\mathrm\{e\}/g, 'e');

    // IMPORTANT: do NOT blindly collapse subscripts before handling \log_{a}(...)
    // We'll keep subscripts and handle selectively.

    let out = '';
    for (let i = 0; i < s.length; ) {
        const ch = s[i];

        if (ch === '\\') {
            const m = s.slice(i + 1).match(/^[a-zA-Z]+/);
            if (!m) throw new Error(`지원하지 않는 LaTeX 명령: \\${s[i+1] || ''}`);
            const name = m[0];
            i += 1 + name.length;

            if (name === 'frac') {
                if (s[i] !== '{') throw new Error("\\frac 뒤에는 { }가 와야 합니다.");
                const g1 = _readGroup(s, i); i = g1.next;
                if (s[i] !== '{') throw new Error("\\frac 분모는 { }로 감싸야 합니다.");
                const g2 = _readGroup(s, i); i = g2.next;
                out += '((' + _latexToMathjsCore(g1.content) + ')/(' + _latexToMathjsCore(g2.content) + '))';
                continue;
            }

            if (name === 'sqrt') {
                if (s[i] !== '{') throw new Error("\\sqrt 뒤에는 { }가 와야 합니다.");
                const g = _readGroup(s, i); i = g.next;
                out += 'sqrt(' + _latexToMathjsCore(g.content) + ')';
                continue;
            }

            // Special: \log_{a}(x) -> log(x, a)

            // functions
            const mapped = _LATEX_FUNC_MAP[name];
            if (mapped) {
                while (s[i] === ' ') i++;

// Base-notation log: \log_{a}(x)  ->  log(x, a)
                if (name === 'log' && s[i] === '_') {
                    // parse base after underscore: _{...} or _a
                    i++; // skip '_'
                    while (s[i] === ' ') i++;
                    let baseAtom = '';
                    if (s[i] === '{') {
                        const gb = _readGroup(s, i); i = gb.next;
                        baseAtom = '(' + _latexToMathjsCore(gb.content) + ')';
                    } else {
                        const ab = _readAtom(s, i);
                        baseAtom = '(' + ab.atom + ')';
                        i = ab.next;
                    }
                    while (s[i] === ' ') i++;

                    // argument: ( ... ) or { ... } or atom
                    const arg = _readAtom(s, i);
                    if (!arg.atom) throw new Error(`\\log 뒤에 인자가 필요합니다.`);
                    i = arg.next;

                    out += 'log(' + arg.atom + ', ' + baseAtom + ')';
                    continue;
                }const atom = _readAtom(s, i);
                if (!atom.atom) throw new Error(`\\${name} 뒤에 인자가 필요합니다.`);
                i = atom.next;
                out += mapped + '(' + atom.atom + ')';
                continue;
            }

            // fallback: unsupported commands
            throw new Error(`지원하지 않는 LaTeX 명령: \\${name}`);
        }

        if (ch === '{') {
            const g = _readGroup(s, i);
            out += '(' + _latexToMathjsCore(g.content) + ')';
            i = g.next;
            continue;
        }

        if (ch === '^') {
            i++;
            let expAtom;
            if (s[i] === '{') {
                const g = _readGroup(s, i);
                expAtom = '(' + _latexToMathjsCore(g.content) + ')';
                i = g.next;
            } else {
                const a = _readAtom(s, i);
                expAtom = '(' + a.atom + ')';
                i = a.next;
            }
            out += '^' + expAtom;
            continue;
        }

        if (ch === '_') {
            // 일반 subscript: x_{1} -> x1 (best-effort)
            // NOTE: \log_{a}는 위에서 이미 처리됨.
            i++;
            while (s[i] === ' ') i++;
            if (s[i] === '{') {
                const g = _readGroup(s, i);
                out += _latexToMathjsCore(g.content);
                i = g.next;
            } else {
                const a = _readAtom(s, i);
                out += a.atom;
                i = a.next;
            }
            continue;
        }

        out += ch;
        i++;
    }

    return out;
}

function _tokenizeExpr(expr) {
    const re = /\s*([0-9]+(?:\.[0-9]+)?|[a-zA-Z_][a-zA-Z0-9_]*|[\+\-\*\/\^\(\),])/g;
    const toks = [];
    let m;
    while ((m = re.exec(expr)) !== null) toks.push(m[1]);
    return toks;
}

function _insertImplicitMultiplication(expr) {
    const toks = _tokenizeExpr(expr);
    const out = [];
    const isId = (t) => /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(t);
    const isNum = (t) => /^[0-9]+(\.[0-9]+)?$/.test(t);
    const isFuncCall = (a, b) => isId(a) && b === '('; // f(
    const canLeft = (t) => isNum(t) || isId(t) || t === ')';
    const canRight = (t) => isNum(t) || isId(t) || t === '(';

    for (let i = 0; i < toks.length; i++) {
        const a = toks[i];
        const b = toks[i + 1];
        out.push(a);
        if (!b) continue;
        if (isFuncCall(a, b)) continue;
        if (canLeft(a) && canRight(b)) out.push('*');
    }
    return out.join(' ');
}

function latexToMathjs(latex) {
    let expr = _latexToMathjsCore(latex);
    expr = expr.replace(/\s+/g, '');
    expr = _insertImplicitMultiplication(expr);

    if (/[{}\\]/.test(expr)) {
        throw new Error("변환 규칙에 맞지 않는 LaTeX가 포함되어 있습니다. (지원: \\frac, \\sqrt, \\sin/\\cos/\\tan, \\sinh/\\cosh/\\tanh, \\arcsin/\\arccos/\\arctan, \\ln/\\log, \\log_{a}(x), \\exp, 거듭제곱 ^ )");
    }

    try {
        math.parse(expr); // parse check
    } catch (e) {
        throw new Error("계산식 문법 오류: " + e.message);
    }

    return expr;
}

function extractSymbolsFromMathjs(expr) {
    const node = math.parse(expr);
    const symbols = new Set();
    node.traverse((n) => {
        if (n && n.isSymbolNode) symbols.add(n.name);
    });

    const builtins = new Set(['pi', 'e', 'i', 'Infinity', 'NaN', 'true', 'false']);
    const funcs = new Set([
        'sin','cos','tan','csc','sec','cot','asin','acos','atan',
        'sinh','cosh','tanh','asinh','acosh','atanh',
        'log','ln','exp','sqrt','abs',
        'min','max','pow'
    ]);

    return [...symbols].filter(s => !builtins.has(s) && !funcs.has(s)).sort();
}

function unknownSymbolsInAnswer(question) {
    const expr = latexToMathjs(question.answer || '');
    const used = extractSymbolsFromMathjs(expr);
    const defined = new Set((question.variables || []).map(v => (v.name || '').trim()).filter(Boolean));
    const unknown = used.filter(s => !defined.has(s));
    return { expr, used, unknown };
}

function _mulberry32(seed) {
    let t = seed >>> 0;
    return function () {
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
}

function _boundsFromQuestion(q) {
    const bounds = {};
    (q.variables || []).forEach(v => {
        const mn = Number(v.min), mx = Number(v.max);
        if (!Number.isFinite(mn) || !Number.isFinite(mx)) {
            throw new Error(`변수 '${v.name}'의 범위가 숫자가 아닙니다.`);
        }
        bounds[v.name] = { min: mn, max: mx };
    });
    return bounds;
}

function evaluateMinMaxApprox(compiled, bounds, samples, seed) {
    const names = Object.keys(bounds);
    if (!names.length) throw new Error("변수 범위가 없습니다. 변수 정보에 최소/최대값을 입력하세요.");

    const rng = _mulberry32(seed || 1);
    const evalAt = (scope) => {
        const y = compiled.evaluate(scope);
        const val = (typeof y === 'number') ? y : (y?.valueOf?.() ?? NaN);
        return Number(val);
    };

    let minVal = Infinity, maxVal = -Infinity;
    let argMin = null, argMax = null;

    const tryPoint = (scope) => {
        let y;
        try { y = evalAt(scope); } catch { return; }
        if (!Number.isFinite(y)) return;
        if (y < minVal) { minVal = y; argMin = { ...scope }; }
        if (y > maxVal) { maxVal = y; argMax = { ...scope }; }
    };

    const n = names.length;
    const cornerCount = 1 << Math.min(n, 12);
    if (n <= 12) {
        for (let mask = 0; mask < (1 << n); mask++) {
            const scope = {};
            for (let i = 0; i < n; i++) {
                const b = bounds[names[i]];
                scope[names[i]] = (mask & (1 << i)) ? b.max : b.min;
            }
            tryPoint(scope);
        }
    } else {
        for (let k = 0; k < cornerCount; k++) {
            const scope = {};
            for (let i = 0; i < n; i++) {
                const b = bounds[names[i]];
                scope[names[i]] = (rng() < 0.5) ? b.min : b.max;
            }
            tryPoint(scope);
        }
    }

    samples = Math.max(200, Math.floor(samples || 2000));
    for (let s = 0; s < samples; s++) {
        const scope = {};
        for (const name of names) {
            const b = bounds[name];
            scope[name] = b.min + (b.max - b.min) * rng();
        }
        tryPoint(scope);
    }

    if (!Number.isFinite(minVal) || !Number.isFinite(maxVal)) {
        throw new Error("유효한 값이 계산되지 않았습니다. (정의역 오류/0으로 나눔/무한/NaN 등)");
    }

    return { minVal, maxVal, argMin, argMax };
}

function _escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, ch => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[ch]));
}

function _scopeToChips(scope) {
    if (!scope || typeof scope !== 'object') return '';
    const keys = Object.keys(scope).sort();
    if (keys.length === 0) return '<span class="text-gray-400">(없음)</span>';
    return `<div class="mt-2 flex flex-wrap gap-1">` + keys.map(k => {
        const v = scope[k];
        return `<span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-2 py-0.5 text-xs font-mono text-gray-800">
            ${_escapeHtml(k)}=<span class="ml-1">${_escapeHtml(v)}</span>
        </span>`;
    }).join('') + `</div>`;
}


            const getCurrentQuestion = () => state.questions[state.currentIndex];

            const highlightVarsInKatex = (text) =>
                (text || '').replace(/\*([a-zA-Z_][a-zA-Z0-9_]*)\*/g,
                    (match, varName) => `{\\color{#2563EB}\\mathbf{${varName}}}`);

            const validateQuestion = (question, index) => {
                const errors = [];
                const prefix = `[문항 ${index + 1}] `;

                // 지문에 등장한 변수 / 지문+정답식 전체에서 등장한 변수
                const varsInTextOnly = extractVariables(question.text || '');
                const varsInAll = extractVariables(question.text); // 변수 목록은 지문(*var*) 기준

                if (!question.id) {
                    errors.push(prefix + "문제 ID를 입력하세요.");
                } else if (!/^[a-zA-Z0-9_()-]+$/.test(question.id)) {
                    errors.push(prefix + "ID는 영문, 숫자, 밑줄(_), 하이픈(-), 괄호()만 사용할 수 있습니다.");
                }

                if (!question.text) errors.push(prefix + "지문을 입력하세요.");
                if (!question.answer) errors.push(prefix + "정답식을 입력하세요.");

                // ★ 지문이 공백이 아닌데 변수(*var*)가 하나도 없으면 오류 처리
                if ((question.text || '').trim() && varsInTextOnly.length === 0) {
                    errors.push(prefix + "지문에 지정된 변수가 하나도 없습니다. *var* 형식으로 변수를 입력하세요.");
                }

                const definedVarNames = new Set((question.variables || []).map(v => v.name));

                // 정답식(LaTeX)에서 사용한 기호가 변수 목록에 있는지 검사
                if (question.answer && (question.answer || '').trim()) {
                    try {
                        const { unknown } = unknownSymbolsInAnswer(question);
                        if (unknown.length) {
                            errors.push(prefix + `정답식에 변수 목록에 없는 기호가 포함되어 있습니다: ${unknown.join(', ')}`);
                        }
                    } catch (e) {
                        errors.push(prefix + `정답식 변환 실패: ${e.message || e}`);
                    }
                }


                // 변수 목록 일치 여부 (둘 다 0개인 경우는 스킵)
                if ((varsInAll.length > 0 || definedVarNames.size > 0) &&
                    (varsInAll.length !== definedVarNames.size ||
                     !varsInAll.every(v => definedVarNames.has(v)))) {
                    errors.push(prefix + "지문 변수(*var*)와 변수 정보 목록이 일치하지 않습니다.");
                }

                (question.variables || []).forEach(v => {
                    if (!v.name) errors.push(prefix + "변수 이름이 비어있습니다.");
                    if (v.min === '' || v.max === '') {
                        errors.push(prefix + `변수 '${v.name}'의 최소/최대값을 모두 입력하세요.`);
                    } else {
                        if (isNaN(Number(v.min)) || isNaN(Number(v.max))) {
                            errors.push(prefix + `변수 '${v.name}'의 범위는 숫자여야 합니다.`);
                        } else if (Number(v.min) > Number(v.max)) {
                            errors.push(prefix + `변수 '${v.name}'의 최소값은 최대값보다 클 수 없습니다.`);
                        }
                        if (getDecimalPlaces(v.min) !== getDecimalPlaces(v.max)) {
                            errors.push(prefix + `변수 '${v.name}'의 최소/최대값의 소수점 자릿수가 다릅니다.`);
                        }
                    }
                });

                return errors;
            };

            const validateAll = () => {
                let allErrors = [];
                state.questions.forEach((q, idx) => {
                    allErrors = allErrors.concat(validateQuestion(q, idx));
                });
                return allErrors;
            };

            const updateQuestionSelectorUI = () => {
                if (!dom.questionSelect) return;
                dom.questionSelect.innerHTML = '';
                state.questions.forEach((q, idx) => {
                    const option = document.createElement('option');
                    option.value = String(idx);
                    let label = `${idx + 1}번`;
                    if (q.id) label += ` [${q.id}]`;
                    if (q.title) label += ` ${q.title}`;
                    option.textContent = label;
                    dom.questionSelect.appendChild(option);
                });
                dom.questionSelect.value = String(state.currentIndex);
            };

            const updateVariablesUIForCurrentQuestion = () => {
                const current = getCurrentQuestion();
                const currentVars = extractVariables(current.text, current.answer);
                dom.variablesContainer.innerHTML = '';

                if (currentVars.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm';
                    const tbody = document.createElement('tbody');
                    const header = document.createElement('thead');
                    header.innerHTML = `
                        <tr class="text-left">
                            <th class="py-1 px-2 font-semibold">변수명</th>
                            <th class="py-1 px-2 font-semibold">최소값</th>
                            <th class="py-1 px-2 font-semibold">최대값</th>
                        </tr>`;
                    table.appendChild(header);

                    const newVariablesState = [];
                    currentVars.forEach(varName => {
                        const existingVar = (current.variables || []).find(v => v.name === varName) || { name: varName, min: '', max: '' };
                        newVariablesState.push(existingVar);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="py-1 px-2 font-mono font-semibold">${varName}</td>
                            <td><input type="text" data-var-name="${varName}" data-var-prop="min" value="${existingVar.min || ''}" class="w-full p-1 rounded-md border-gray-300 text-right"></td>
                            <td><input type="text" data-var-name="${varName}" data-var-prop="max" value="${existingVar.max || ''}" class="w-full p-1 rounded-md border-gray-300 text-right"></td>
                        `;
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);
                    dom.variablesContainer.appendChild(table);
                    current.variables = newVariablesState;
                } else {
                    dom.variablesContainer.innerHTML = '<p class="text-sm text-gray-500">지문에 변수를 입력하면 자동으로 생성됩니다.</p>';
                    current.variables = [];
                }
            };

            // JSON 실시간 출력 제거: 이제 검증만 수행
            const updateJsonAndValidation = () => {
                const errors = validateAll();
                if (errors.length > 0) {
                    dom.validationErrors.innerHTML = errors.map(e => `<div>- ${e}</div>`).join('');
                    dom.validationErrors.classList.remove('hidden');
                    dom.saveJsonBtn.disabled = true;
                } else {
                    dom.validationErrors.classList.add('hidden');
                    dom.validationErrors.innerHTML = '';
                    dom.saveJsonBtn.disabled = false;
                }
            };

            const updateUI = () => {
                if (state.currentIndex < 0) state.currentIndex = 0;
                if (state.currentIndex >= state.questions.length) state.currentIndex = state.questions.length - 1;

                const current = getCurrentQuestion();

                // 문항 선택 UI
                updateQuestionSelectorUI();

                // 입력 필드 반영
                dom.id.value = current.id || '';
                dom.title.value = current.title || '';
                if (dom.points) dom.points.value = (current.points ?? '') === null ? '' : String(current.points ?? '');
                dom.text.value = current.text || '';
                dom.answer.value = current.answer || '';

                // 정답 범위 패널 초기화
                if (dom.minmaxResult) { dom.minmaxResult.classList.add('hidden'); dom.minmaxResult.innerHTML = ''; }
                if (dom.answerMathjs) { dom.answerMathjs.classList.add('hidden'); dom.answerMathjs.textContent = ''; }

                // 지문 미리보기
                dom.textPreview.innerHTML = highlightVarsInKatex(current.text || '');

                // 정답식 미리보기 (변수 강조 제거)
                dom.answerPreview.innerHTML = `$$${(current.answer || '').replace(/\*([a-zA-Z_][a-zA-Z0-9_]*)\*/g, '$1')}$$`;

                if (window.renderMathInElement) {
                    renderMathInElement(document.body, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false },
                        ],
                        throwOnError: false,
                        trust: true
                    });
                }

                // 변수 UI
                updateVariablesUIForCurrentQuestion();

                // 삭제 버튼 상태
                dom.deleteQuestionBtn.disabled = state.questions.length <= 1;

                // 검증
                updateJsonAndValidation();
            };

            const downloadFile = (filename, content, type = 'text/plain;charset=utf-8') => {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const getJsonFilename = () => {
                if (state.questions.length === 1 && state.questions[0].id) {
                    return state.questions[0].id;
                }
                return 'questions';
            };

            const setupEventListeners = () => {
                const inputs = [dom.id, dom.title, dom.points, dom.text, dom.answer];
                inputs.forEach(input => {
                    if (!input) return;
                    input.addEventListener('input', e => {
                        const current = getCurrentQuestion();
                        const prop = e.target.id; // 'id', 'title', 'text', 'answer'
                        current[prop] = e.target.value;
                        updateUI();
                    });
                });

// 정답 범위(min/max) 계산 버튼
if (dom.calcMinMaxBtn) {
    dom.calcMinMaxBtn.addEventListener('click', () => {
        const current = getCurrentQuestion();
        try {
            // 1) LaTeX -> math.js 변환
            const expr = latexToMathjs(current.answer || '');

            // 2) 변수 불일치 검사(검증과 동일 규칙)
            const used = extractSymbolsFromMathjs(expr);
            const defined = new Set((current.variables || []).map(v => (v.name || '').trim()).filter(Boolean));
            const unknown = used.filter(s => !defined.has(s));
            if (unknown.length) {
                throw new Error(`정답식에 변수 목록에 없는 기호가 포함되어 있습니다: ${unknown.join(', ')}`);
            }

            if (dom.answerMathjs) {
                dom.answerMathjs.classList.remove('hidden');
                dom.answerMathjs.textContent = "math.js: " + expr;
            }

            // 3) bounds + compile
            const compiled = math.compile(expr);
            const bounds = _boundsFromQuestion(current);

            const samples = Number(dom.minmaxSamples?.value || 2000);
            const seed = Number(dom.minmaxSeed?.value || 1);

            const r = evaluateMinMaxApprox(compiled, bounds, samples, seed);

            if (dom.minmaxResult) {
                dom.minmaxResult.classList.remove('hidden');
                dom.minmaxResult.innerHTML = `
                    <div class="rounded-lg border border-gray-200 bg-white p-3">
                        <div class="flex items-center justify-between">
                            <div class="font-semibold text-gray-800">결과 (근사)</div>
                            <div class="text-xs text-gray-500">샘플 ${samples.toLocaleString()} · 시드 ${seed}</div>
                        </div>

                        <div class="mt-3 grid grid-cols-1 xl:grid-cols-2 gap-3">
                            <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
                                <div class="text-xs font-medium text-gray-500">최소값 (min)</div>
                                <div class="mt-1 text-2xl font-semibold text-gray-900 font-mono break-all">${r.minVal}</div>
                                <div class="mt-3 text-xs font-medium text-gray-600">최소화 변수</div>
                                ${_scopeToChips(r.argMin)}
                            </div>

                            <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
                                <div class="text-xs font-medium text-gray-500">최대값 (max)</div>
                                <div class="mt-1 text-2xl font-semibold text-gray-900 font-mono break-all">${r.maxVal}</div>
                                <div class="mt-3 text-xs font-medium text-gray-600">최대화 변수</div>
                                ${_scopeToChips(r.argMax)}
                            </div>
                        </div>

                        <div class="mt-3 text-xs text-gray-500">
                            ※ 전역 최적 “보장”이 아니라 샘플링 기반 근사입니다. 샘플 수를 늘리면 더 안정적입니다.
                        </div>
                    </div>
                `;
            }

            // 계산 성공 시, 우측 오류 패널은 그대로(전체 검증 오류는 updateJsonAndValidation에서 관리)
        } catch (e) {
            if (dom.minmaxResult) {
                dom.minmaxResult.classList.remove('hidden');
                dom.minmaxResult.innerHTML = `
                    <div class="rounded-lg border border-red-200 bg-red-50 p-3">
                        <div class="font-semibold text-red-800">현재 문제 점검 실패</div>
                        <div class="mt-1 text-sm text-red-800">${_escapeHtml(String(e.message || e))}</div>
                        <div class="mt-2 text-xs text-red-700">
                            지원: \\frac, \\sqrt, \\sin/\\cos/\\tan, \\sinh/\\cosh/\\tanh, \\arcsin/\\arccos/\\arctan, \\ln/\\log, \\log_{a}(x), \\exp, 거듭제곱 ^, 괄호/중괄호
                        </div>
                    </div>
                `;
            }
        }
    });
}


// 전체 문항 정답범위 일괄 점검
let _lastMinMaxBatchReport = null;

function _classifyRange(minVal, maxVal) {
    const TH_MIN = 0.1;
    const TH_MAX = 10000;
    const reasons = [];
    if (!(Number.isFinite(minVal) && Number.isFinite(maxVal))) {
        reasons.push("min/max 비유한");
        return { ok: false, reasons };
    }
    if (minVal >= maxVal) reasons.push("min ≥ max");
    if (minVal < TH_MIN) reasons.push(`min < ${TH_MIN}`);
    if (maxVal > TH_MAX) reasons.push(`max > ${TH_MAX}`);
    return { ok: reasons.length === 0, reasons };
}

function runMinMaxBatchCheck() {
    const samples = Number(dom.minmaxSamples?.value || 2000);
    const seedBase = Number(dom.minmaxSeed?.value || 1);

    const report = {
        meta: { total: state.questions.length, samples, seedBase, thMin: 0.1, thMax: 10000, ts: new Date().toISOString() },
        ok: [],
        range_violation: [],
        error: []
    };

    state.questions.forEach((q, idx) => {
        try {
            const expr = latexToMathjs(q.answer || '');

            const used = extractSymbolsFromMathjs(expr);
            const defined = new Set((q.variables || []).map(v => (v.name || '').trim()).filter(Boolean));
            const unknown = used.filter(s => !defined.has(s));
            if (unknown.length) {
                throw new Error(`정답식에 변수 목록에 없는 기호가 포함되어 있습니다: ${unknown.join(', ')}`);
            }

            const compiled = math.compile(expr);
            const bounds = _boundsFromQuestion(q);

            // 문항별로 seed 살짝 변경(재현성 유지 + 동일 시드 충돌 완화)
            const seed = seedBase + idx;

            const r = evaluateMinMaxApprox(compiled, bounds, samples, seed);
            const cls = _classifyRange(r.minVal, r.maxVal);

            if (cls.ok) {
                report.ok.push({ index: idx + 1, id: q.id || '', min: r.minVal, max: r.maxVal });
            } else {
                report.range_violation.push({
                    index: idx + 1,
                    id: q.id || '',
                    min: r.minVal,
                    max: r.maxVal,
                    reason: cls.reasons.join(', ')
                });
            }
        } catch (e) {
            report.error.push({
                index: idx + 1,
                id: q.id || '',
                message: String(e?.message || e)
            });
        }
    });

    _lastMinMaxBatchReport = report;

    // UI 요약
    if (dom.minmaxAllResult) {
        dom.minmaxAllResult.classList.remove('hidden');

        const okCount = report.ok.length;
        const vioCount = report.range_violation.length;
        const errCount = report.error.length;
        const total = report.meta.total;

        const totalPoints = state.questions.reduce((acc, qq) => {
            const n = Number(qq?.points);
            return acc + (Number.isFinite(n) ? n : 0);
        }, 0);

        const boxClass = errCount ? 'border-red-200 bg-red-50' : (vioCount ? 'border-amber-200 bg-amber-50' : 'border-green-200 bg-green-50');
        const titleClass = errCount ? 'text-red-800' : (vioCount ? 'text-amber-800' : 'text-green-800');

        dom.minmaxAllResult.innerHTML = `
            <div class="rounded-lg border ${boxClass} p-3">
                <div class="flex flex-wrap items-center gap-2 text-sm">
                    <span class="font-semibold ${titleClass}">전체 문항 점검 결과</span>

                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 border border-green-400 text-green-900">
                        통과 <span class="font-semibold">${okCount}</span>
                    </span>

                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-100 border border-amber-400 text-amber-900">
                        범위위반 <span class="font-semibold">${vioCount}</span>
                    </span>

                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 border border-red-400 text-red-900">
                        계산에러 <span class="font-semibold">${errCount}</span>
                    </span>

                    <span class="ml-auto inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 border border-slate-400 text-slate-900">
                        총점 <span class="font-semibold">${totalPoints}</span>
                    </span>

                    <span class="text-xs text-slate-600">총 ${total}</span>
                </div>
            </div>
        `;
        }

    // 테이블 즉시 출력
    renderMinMaxReportTable(report);
}



function _statusRank(s) {
    if (s === '계산에러') return 0;
    if (s === '범위위반') return 1;
    if (s === '통과') return 2;
    return 9;
}

function renderMinMaxReportTable(rep) {
    if (!rep || !dom.minmaxReportTable) return;

    const rows = [];

    const pointsOf = (qIndex) => {
        const p = state.questions?.[qIndex]?.points;
        const n = Number(p);
        return Number.isFinite(n) ? n : '';
    };
    (rep.ok || []).forEach(r => rows.push({ qIndex: ((r.index || 1) - 1), index: r.index, id: r.id, points: pointsOf(((r.index || 1) - 1)), min: r.min, max: r.max, status: '통과', note: '' }));
    (rep.range_violation || []).forEach(r => rows.push({ qIndex: ((r.index || 1) - 1), index: r.index, id: r.id, points: pointsOf(((r.index || 1) - 1)), min: r.min, max: r.max, status: '범위위반', note: r.reason }));
    (rep.error || []).forEach(r => rows.push({ qIndex: ((r.index || 1) - 1), index: r.index, id: r.id, points: pointsOf(((r.index || 1) - 1)), min: '', max: '', status: '계산에러', note: r.message }));

    // 상태 -> ID 정렬 (통과하지 않은 항목이 위로 오도록)
    rows.sort((a, b) => {
        const sa = _statusRank(a.status);
        const sb = _statusRank(b.status);
        if (sa !== sb) return sa - sb;

        const ida = String(a.id || '');
        const idb = String(b.id || '');
        const cmp = ida.localeCompare(idb, undefined, { numeric: true, sensitivity: 'base' });
        if (cmp !== 0) return cmp;

        return (a.index || 0) - (b.index || 0);
    });

    const statusBadge = (s) => {
        if (s === '통과') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-900 border border-green-400">통과</span>';
        if (s === '범위위반') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-900 border border-amber-400">범위위반</span>';
        return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-900 border border-red-400">계산에러</span>';
    };

    const okCount = (rep.ok || []).length;
    const vioCount = (rep.range_violation || []).length;
    const errCount = (rep.error || []).length;

    dom.minmaxReportTable.classList.remove('hidden');
    dom.minmaxReportTable.innerHTML = `
        <div class="rounded-lg border border-gray-200 bg-white p-3">
            
            <div class="text-sm text-gray-700">
                정렬: <span class="font-semibold">상태 → ID</span> (통과하지 않은 항목이 위쪽). 
                <span class="font-semibold">ID</span>를 클릭하면 해당 문항으로 이동합니다.
            </div>
<div class="mt-2 overflow-auto max-h-[60vh] border border-gray-200 rounded-md">
                <table class="min-w-full text-xs">
                    <thead class="sticky top-0 bg-gray-50 border-b border-gray-200">
                        <tr class="text-left text-gray-700">
                            <th class="px-3 py-2 whitespace-nowrap">#</th>
                            <th class="px-3 py-2 whitespace-nowrap">ID</th>
                            <th class="px-3 py-2 whitespace-nowrap">상태</th>
                            <th class="px-3 py-2 whitespace-nowrap">points</th>
                            <th class="px-3 py-2 whitespace-nowrap">min</th>
                            <th class="px-3 py-2 whitespace-nowrap">max</th>
                            <th class="px-3 py-2">사유/메시지</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${rows.map(r => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2 whitespace-nowrap text-gray-700">${r.index}</td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <button type="button"
                                        class="font-mono text-blue-600 hover:underline"
                                        data-goto-question="${r.qIndex}">
                                        ${_escapeHtml(r.id || '')}
                                    </button>
                                </td>
                                <td class="px-3 py-2 whitespace-nowrap">${statusBadge(r.status)}</td>
                                <td class="px-3 py-2 whitespace-nowrap font-mono text-gray-700">${(r.points === '' ? '' : String(r.points))}</td>
                                <td class="px-3 py-2 whitespace-nowrap font-mono text-gray-700">${(r.min === '' ? '' : String(r.min))}</td>
                                <td class="px-3 py-2 whitespace-nowrap font-mono text-gray-700">${(r.max === '' ? '' : String(r.max))}</td>
                                <td class="px-3 py-2 text-gray-700">${_escapeHtml(r.note || '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // 결과가 생성되면 표 영역으로 스크롤
    dom.minmaxReportTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 버튼 이벤트
if (dom.calcMinMaxAllBtn) {
    dom.calcMinMaxAllBtn.addEventListener('click', runMinMaxBatchCheck);
}

// 결과 테이블에서 ID 클릭 → 해당 문항으로 이동
if (dom.minmaxReportTable) {
    dom.minmaxReportTable.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-goto-question]');
        if (!btn) return;
        e.preventDefault();

        const qIdx = Number(btn.dataset.gotoQuestion);
        if (!Number.isFinite(qIdx)) return;
        if (qIdx < 0 || qIdx >= state.questions.length) return;

        state.currentIndex = qIdx;
        updateUI();

        // 좌측 입력 영역으로 시선 이동(선택 사항)
        if (dom.id) {
            dom.id.scrollIntoView({ behavior: 'smooth', block: 'center' });
            dom.id.focus();
        }
    });
}


                
                dom.variablesContainer.addEventListener('input', e => {
                    if (e.target.tagName === 'INPUT') {
                        const { varName, varProp } = e.target.dataset;
                        const current = getCurrentQuestion();
                        const variable = (current.variables || []).find(v => v.name === varName);
                        if (variable) { variable[varProp] = e.target.value; }
                        updateJsonAndValidation();
                    }
                });

                dom.saveJsonBtn.addEventListener('click', () => {
                    if (validateAll().length === 0) {
                        const exportQuestions = state.questions.map(q => {
    const out = {
        id: q.id || '',
        title: q.title || '',
        text: q.text || '',
        answer: q.answer || '',
        variables: Array.isArray(q.variables) ? q.variables.map(v => ({
            name: v.name || '',
            min: v.min ?? '',
            max: v.max ?? ''
        })) : []
    };

    // points는 옵션: 비어 있으면 저장하지 않음
    if (q.points !== undefined && q.points !== null && String(q.points).trim() !== '') {
        const p = Number(q.points);
        out.points = Number.isFinite(p) ? p : q.points;
    }
    return out;
});

const jsonContent = JSON.stringify({ questions: exportQuestions }, null, 2);
downloadFile(`${getJsonFilename()}.json`, jsonContent, 'application/json');
                    } else {
                        alert('JSON을 저장하기 전에 모든 오류를 해결해 주세요.');
                    }
                });

                dom.loadJsonBtn.addEventListener('click', () => dom.fileInput.click());

                dom.fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {
                                state.questions = data.questions.map(q => ({
                                    id: q.id || '',
                                    title: q.title || '',
                                    text: q.text || '',
                                    answer: q.answer || '',
                                    points: (q.points ?? '') === null ? '' : q.points,
                                    variables: Array.isArray(q.variables) ? q.variables.map(v => ({
                                        name: v.name || '',
                                        min: v.min ?? '',
                                        max: v.max ?? ''
                                    })) : []
                                }));
                                state.currentIndex = 0;
                                updateUI();
                            } else {
                                throw new Error("'questions' 배열을 포함한 올바른 JSON 형식이 아닙니다.");
                            }
                        } catch (err) {
                            alert(`파일 읽기 오류: ${err.message}`);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                });

                dom.questionSelect.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.value, 10);
                    if (!Number.isNaN(idx) && idx >= 0 && idx < state.questions.length) {
                        state.currentIndex = idx;
                        updateUI();
                    }
                });

                dom.addQuestionBtn.addEventListener('click', () => {
                    state.questions.push(createEmptyQuestion());
                    state.currentIndex = state.questions.length - 1;
                    updateUI();
                });

                dom.deleteQuestionBtn.addEventListener('click', () => {
                    if (state.questions.length <= 1) return;
                    if (!confirm('현재 문항을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
                    state.questions.splice(state.currentIndex, 1);
                    if (state.currentIndex >= state.questions.length) {
                        state.currentIndex = state.questions.length - 1;
                    }
                    updateUI();
                });
            };

            setupEventListeners();
            updateUI();
        });
    </script>
</body>
</html>
